var ROT={isSupported:function(){return!(!document.createElement("canvas").getContext||!Function.prototype.bind)},DEFAULT_WIDTH:80,DEFAULT_HEIGHT:25,DIRS:{4:[[0,-1],[1,0],[0,1],[-1,0]],8:[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],6:[[-1,-1],[1,-1],[2,0],[1,1],[-1,1],[-2,0]]},VK_CANCEL:3,VK_HELP:6,VK_BACK_SPACE:8,VK_TAB:9,VK_CLEAR:12,VK_RETURN:13,VK_ENTER:14,VK_SHIFT:16,VK_CONTROL:17,VK_ALT:18,VK_PAUSE:19,VK_CAPS_LOCK:20,VK_ESCAPE:27,VK_SPACE:32,VK_PAGE_UP:33,VK_PAGE_DOWN:34,VK_END:35,VK_HOME:36,VK_LEFT:37,VK_UP:38,VK_RIGHT:39,VK_DOWN:40,VK_PRINTSCREEN:44,VK_INSERT:45,VK_DELETE:46,VK_0:48,VK_1:49,VK_2:50,VK_3:51,VK_4:52,VK_5:53,VK_6:54,VK_7:55,VK_8:56,VK_9:57,VK_COLON:58,VK_SEMICOLON:59,VK_LESS_THAN:60,VK_EQUALS:61,VK_GREATER_THAN:62,VK_QUESTION_MARK:63,VK_AT:64,VK_A:65,VK_B:66,VK_C:67,VK_D:68,VK_E:69,VK_F:70,VK_G:71,VK_H:72,VK_I:73,VK_J:74,VK_K:75,VK_L:76,VK_M:77,VK_N:78,VK_O:79,VK_P:80,VK_Q:81,VK_R:82,VK_S:83,VK_T:84,VK_U:85,VK_V:86,VK_W:87,VK_X:88,VK_Y:89,VK_Z:90,VK_CONTEXT_MENU:93,VK_NUMPAD0:96,VK_NUMPAD1:97,VK_NUMPAD2:98,VK_NUMPAD3:99,VK_NUMPAD4:100,VK_NUMPAD5:101,VK_NUMPAD6:102,VK_NUMPAD7:103,VK_NUMPAD8:104,VK_NUMPAD9:105,VK_MULTIPLY:106,VK_ADD:107,VK_SEPARATOR:108,VK_SUBTRACT:109,VK_DECIMAL:110,VK_DIVIDE:111,VK_F1:112,VK_F2:113,VK_F3:114,VK_F4:115,VK_F5:116,VK_F6:117,VK_F7:118,VK_F8:119,VK_F9:120,VK_F10:121,VK_F11:122,VK_F12:123,VK_F13:124,VK_F14:125,VK_F15:126,VK_F16:127,VK_F17:128,VK_F18:129,VK_F19:130,VK_F20:131,VK_F21:132,VK_F22:133,VK_F23:134,VK_F24:135,VK_NUM_LOCK:144,VK_SCROLL_LOCK:145,VK_CIRCUMFLEX:160,VK_EXCLAMATION:161,VK_DOUBLE_QUOTE:162,VK_HASH:163,VK_DOLLAR:164,VK_PERCENT:165,VK_AMPERSAND:166,VK_UNDERSCORE:167,VK_OPEN_PAREN:168,VK_CLOSE_PAREN:169,VK_ASTERISK:170,VK_PLUS:171,VK_PIPE:172,VK_HYPHEN_MINUS:173,VK_OPEN_CURLY_BRACKET:174,VK_CLOSE_CURLY_BRACKET:175,VK_TILDE:176,VK_COMMA:188,VK_PERIOD:190,VK_SLASH:191,VK_BACK_QUOTE:192,VK_OPEN_BRACKET:219,VK_BACK_SLASH:220,VK_CLOSE_BRACKET:221,VK_QUOTE:222,VK_META:224,VK_ALTGR:225,VK_WIN:91,VK_KANA:21,VK_HANGUL:21,VK_EISU:22,VK_JUNJA:23,VK_FINAL:24,VK_HANJA:25,VK_KANJI:25,VK_CONVERT:28,VK_NONCONVERT:29,VK_ACCEPT:30,VK_MODECHANGE:31,VK_SELECT:41,VK_PRINT:42,VK_EXECUTE:43,VK_SLEEP:95};ROT.Text={RE_COLORS:/%([bc]){([^}]*)}/g,TYPE_TEXT:0,TYPE_NEWLINE:1,TYPE_FG:2,TYPE_BG:3,measure:function(t,i){for(var e={width:0,height:1},o=this.tokenize(t,i),r=0,n=0;n<o.length;n++){var s=o[n];switch(s.type){case this.TYPE_TEXT:r+=s.value.length;break;case this.TYPE_NEWLINE:e.height++,e.width=Math.max(e.width,r),r=0}}return e.width=Math.max(e.width,r),e},tokenize:function(t,i){var e=[],o=0;t.replace(this.RE_COLORS,function(i,r,n,s){var a=t.substring(o,s);return a.length&&e.push({type:ROT.Text.TYPE_TEXT,value:a}),e.push({type:"c"==r?ROT.Text.TYPE_FG:ROT.Text.TYPE_BG,value:n.trim()}),o=s+i.length,""});var r=t.substring(o);return r.length&&e.push({type:ROT.Text.TYPE_TEXT,value:r}),this._breakLines(e,i)},_breakLines:function(t,i){i||(i=1/0);for(var e=0,o=0,r=-1;e<t.length;){var n=t[e];if(n.type==ROT.Text.TYPE_NEWLINE&&(o=0,r=-1),n.type==ROT.Text.TYPE_TEXT){for(;0==o&&" "==n.value.charAt(0);)n.value=n.value.substring(1);var s=n.value.indexOf("\n");if(-1!=s){n.value=this._breakInsideToken(t,e,s,!0);for(var a=n.value.split("");a.length&&" "==a[a.length-1];)a.pop();n.value=a.join("")}if(n.value.length){if(o+n.value.length>i){for(var s=-1;;){var h=n.value.indexOf(" ",s+1);if(-1==h)break;if(o+h>i)break;s=h}if(-1!=s)n.value=this._breakInsideToken(t,e,s,!0);else if(-1!=r){var n=t[r],l=n.value.lastIndexOf(" ");n.value=this._breakInsideToken(t,r,l,!0),e=r}else n.value=this._breakInsideToken(t,e,i-o,!1)}else o+=n.value.length,-1!=n.value.indexOf(" ")&&(r=e);e++}else t.splice(e,1)}else e++}t.push({type:ROT.Text.TYPE_NEWLINE});for(var c=null,e=0;e<t.length;e++){var n=t[e];switch(n.type){case ROT.Text.TYPE_TEXT:c=n;break;case ROT.Text.TYPE_NEWLINE:if(c){for(var a=c.value.split("");a.length&&" "==a[a.length-1];)a.pop();c.value=a.join("")}c=null}}return t.pop(),t},_breakInsideToken:function(t,i,e,o){var r={type:ROT.Text.TYPE_NEWLINE},n={type:ROT.Text.TYPE_TEXT,value:t[i].value.substring(e+(o?1:0))};return t.splice(i+1,0,r,n),t[i].value.substring(0,e)}},Array.prototype.random=Array.prototype.random||function(){return this.length?this[Math.floor(ROT.RNG.getUniform()*this.length)]:null},Array.prototype.randomize=Array.prototype.randomize||function(){for(var t=[];this.length;){var i=this.indexOf(this.random());t.push(this.splice(i,1)[0])}return t},Number.prototype.mod=Number.prototype.mod||function(t){return(this%t+t)%t},String.prototype.capitalize=String.prototype.capitalize||function(){return this.charAt(0).toUpperCase()+this.substring(1)},String.prototype.lpad=String.prototype.lpad||function(t,i){for(var e=t||"0",o=i||2,r="";r.length<o-this.length;)r+=e;return r=r.substring(0,o-this.length),r+this},String.prototype.rpad=String.prototype.rpad||function(t,i){for(var e=t||"0",o=i||2,r="";r.length<o-this.length;)r+=e;return r=r.substring(0,o-this.length),this+r},String.format=String.format||function(t){var i=String.format.map,e=Array.prototype.slice.call(arguments,1),o=function(o,r,n,s){if("%"==t.charAt(s-1))return o.substring(1);if(!e.length)return o;var a=e[0],h=r||n,l=h.split(","),c=l.shift(),p=i[c.toLowerCase()];if(!p)return o;var a=e.shift(),_=a[p].apply(a,l),u=c.charAt(0);return u!=u.toLowerCase()&&(_=_.capitalize()),_};return t.replace(/%(?:([a-z]+)|(?:{([^}]+)}))/gi,o)},String.format.map=String.format.map||{s:"toString"},String.prototype.format=String.prototype.format||function(){var t=Array.prototype.slice.call(arguments);return t.unshift(this),String.format.apply(String,t)},Object.create||(Object.create=function(t){var i=function(){};return i.prototype=t,new i}),Function.prototype.extend=Function.prototype.extend||function(t){return this.prototype=Object.create(t.prototype),this.prototype.constructor=this,this},"undefined"!=typeof window&&(window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){return setTimeout(t,1e3/60)},window.cancelAnimationFrame=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.oCancelAnimationFrame||window.msCancelAnimationFrame||function(t){return clearTimeout(t)}),ROT.Display=function(t){var i=document.createElement("canvas");this._context=i.getContext("2d"),this._data={},this._dirty=!1,this._options={},this._backend=null;var e={width:ROT.DEFAULT_WIDTH,height:ROT.DEFAULT_HEIGHT,transpose:!1,layout:"rect",fontSize:15,spacing:1,border:0,forceSquareRatio:!1,fontFamily:"monospace",fontStyle:"",fg:"#ccc",bg:"#000",tileWidth:32,tileHeight:32,tileMap:{},tileSet:null,tileColorize:!1,termColor:"xterm"};for(var o in t)e[o]=t[o];this.setOptions(e),this.DEBUG=this.DEBUG.bind(this),this._tick=this._tick.bind(this),requestAnimationFrame(this._tick)},ROT.Display.prototype.DEBUG=function(t,i,e){var o=[this._options.bg,this._options.fg];this.draw(t,i,null,null,o[e%o.length])},ROT.Display.prototype.clear=function(){this._data={},this._dirty=!0},ROT.Display.prototype.setOptions=function(t){for(var i in t)this._options[i]=t[i];if(t.width||t.height||t.fontSize||t.fontFamily||t.spacing||t.layout){t.layout&&(this._backend=new(ROT.Display[t.layout.capitalize()])(this._context));var e=(this._options.fontStyle?this._options.fontStyle+" ":"")+this._options.fontSize+"px "+this._options.fontFamily;this._context.font=e,this._backend.compute(this._options),this._context.font=e,this._context.textAlign="center",this._context.textBaseline="middle",this._dirty=!0}return this},ROT.Display.prototype.getOptions=function(){return this._options},ROT.Display.prototype.getContainer=function(){return this._context.canvas},ROT.Display.prototype.computeSize=function(t,i){return this._backend.computeSize(t,i,this._options)},ROT.Display.prototype.computeFontSize=function(t,i){return this._backend.computeFontSize(t,i,this._options)},ROT.Display.prototype.eventToPosition=function(t){if(t.touches)var i=t.touches[0].clientX,e=t.touches[0].clientY;else var i=t.clientX,e=t.clientY;var o=this._context.canvas.getBoundingClientRect();return i-=o.left,e-=o.top,0>i||0>e||i>=this._context.canvas.width||e>=this._context.canvas.height?[-1,-1]:this._backend.eventToPosition(i,e)},ROT.Display.prototype.draw=function(t,i,e,o,r){o||(o=this._options.fg),r||(r=this._options.bg),this._data[t+","+i]=[t,i,e,o,r],this._dirty!==!0&&(this._dirty||(this._dirty={}),this._dirty[t+","+i]=!0)},ROT.Display.prototype.drawText=function(t,i,e,o){var r=null,n=null,s=t,a=i,h=1;o||(o=this._options.width-t);for(var l=ROT.Text.tokenize(e,o);l.length;){var c=l.shift();switch(c.type){case ROT.Text.TYPE_TEXT:for(var p=!1,_=!1,u=!1,f=!1,d=0;d<c.value.length;d++){var g=c.value.charCodeAt(d),R=c.value.charAt(d);u=g>255&&65377>g||g>65500&&65512>g&&g>65518,p=32==R.charCodeAt(0)||12288==R.charCodeAt(0),!f||u||p||s++,u&&!_&&s++,this.draw(s++,a,R,r,n),_=p,f=u}break;case ROT.Text.TYPE_FG:r=c.value||null;break;case ROT.Text.TYPE_BG:n=c.value||null;break;case ROT.Text.TYPE_NEWLINE:s=t,a++,h++}}return h},ROT.Display.prototype._tick=function(){if(requestAnimationFrame(this._tick),this._dirty){if(this._dirty===!0){this._context.fillStyle=this._options.bg,this._context.fillRect(0,0,this._context.canvas.width,this._context.canvas.height);for(var t in this._data)this._draw(t,!1)}else for(var i in this._dirty)this._draw(i,!0);this._dirty=!1}},ROT.Display.prototype._draw=function(t,i){var e=this._data[t];e[4]!=this._options.bg&&(i=!0),this._backend.draw(e,i)},ROT.Display.Backend=function(t){this._context=t},ROT.Display.Backend.prototype.compute=function(){},ROT.Display.Backend.prototype.draw=function(){},ROT.Display.Backend.prototype.computeSize=function(){},ROT.Display.Backend.prototype.computeFontSize=function(){},ROT.Display.Backend.prototype.eventToPosition=function(){},ROT.Display.Rect=function(t){ROT.Display.Backend.call(this,t),this._spacingX=0,this._spacingY=0,this._canvasCache={},this._options={}},ROT.Display.Rect.extend(ROT.Display.Backend),ROT.Display.Rect.cache=!1,ROT.Display.Rect.prototype.compute=function(t){this._canvasCache={},this._options=t;var i=Math.ceil(this._context.measureText("W").width);this._spacingX=Math.ceil(t.spacing*i),this._spacingY=Math.ceil(t.spacing*t.fontSize),this._options.forceSquareRatio&&(this._spacingX=this._spacingY=Math.max(this._spacingX,this._spacingY)),this._context.canvas.width=t.width*this._spacingX,this._context.canvas.height=t.height*this._spacingY},ROT.Display.Rect.prototype.draw=function(t,i){this.constructor.cache?this._drawWithCache(t,i):this._drawNoCache(t,i)},ROT.Display.Rect.prototype._drawWithCache=function(t){var i=t[0],e=t[1],o=t[2],r=t[3],n=t[4],s=""+o+r+n;if(s in this._canvasCache)var a=this._canvasCache[s];else{var h=this._options.border,a=document.createElement("canvas"),l=a.getContext("2d");if(a.width=this._spacingX,a.height=this._spacingY,l.fillStyle=n,l.fillRect(h,h,a.width-h,a.height-h),o){l.fillStyle=r,l.font=this._context.font,l.textAlign="center",l.textBaseline="middle";for(var c=[].concat(o),p=0;p<c.length;p++)l.fillText(c[p],this._spacingX/2,Math.ceil(this._spacingY/2))}this._canvasCache[s]=a}this._context.drawImage(a,i*this._spacingX,e*this._spacingY)},ROT.Display.Rect.prototype._drawNoCache=function(t,i){var e=t[0],o=t[1],r=t[2],n=t[3],s=t[4];if(i){var a=this._options.border;this._context.fillStyle=s,this._context.fillRect(e*this._spacingX+a,o*this._spacingY+a,this._spacingX-a,this._spacingY-a)}if(r){this._context.fillStyle=n;for(var h=[].concat(r),l=0;l<h.length;l++)this._context.fillText(h[l],(e+.5)*this._spacingX,Math.ceil((o+.5)*this._spacingY))}},ROT.Display.Rect.prototype.computeSize=function(t,i){var e=Math.floor(t/this._spacingX),o=Math.floor(i/this._spacingY);return[e,o]},ROT.Display.Rect.prototype.computeFontSize=function(t,i){var e=Math.floor(t/this._options.width),o=Math.floor(i/this._options.height),r=this._context.font;this._context.font="100px "+this._options.fontFamily;var n=Math.ceil(this._context.measureText("W").width);this._context.font=r;var s=n/100,a=s*o/e;return a>1&&(o=Math.floor(o/a)),Math.floor(o/this._options.spacing)},ROT.Display.Rect.prototype.eventToPosition=function(t,i){return[Math.floor(t/this._spacingX),Math.floor(i/this._spacingY)]},ROT.Display.Hex=function(t){ROT.Display.Backend.call(this,t),this._spacingX=0,this._spacingY=0,this._hexSize=0,this._options={}},ROT.Display.Hex.extend(ROT.Display.Backend),ROT.Display.Hex.prototype.compute=function(t){this._options=t;var i=Math.ceil(this._context.measureText("W").width);if(this._hexSize=Math.floor(t.spacing*(t.fontSize+i/Math.sqrt(3))/2),this._spacingX=this._hexSize*Math.sqrt(3)/2,this._spacingY=1.5*this._hexSize,t.transpose)var e="height",o="width";else var e="width",o="height";this._context.canvas[e]=Math.ceil((t.width+1)*this._spacingX),this._context.canvas[o]=Math.ceil((t.height-1)*this._spacingY+2*this._hexSize)},ROT.Display.Hex.prototype.draw=function(t,i){var e=t[0],o=t[1],r=t[2],n=t[3],s=t[4],a=[(e+1)*this._spacingX,o*this._spacingY+this._hexSize];if(this._options.transpose&&a.reverse(),i&&(this._context.fillStyle=s,this._fill(a[0],a[1])),r){this._context.fillStyle=n;for(var h=[].concat(r),l=0;l<h.length;l++)this._context.fillText(h[l],a[0],Math.ceil(a[1]))}},ROT.Display.Hex.prototype.computeSize=function(t,i){this._options.transpose&&(t+=i,i=t-i,t-=i);var e=Math.floor(t/this._spacingX)-1,o=Math.floor((i-2*this._hexSize)/this._spacingY+1);return[e,o]},ROT.Display.Hex.prototype.computeFontSize=function(t,i){this._options.transpose&&(t+=i,i=t-i,t-=i);var e=2*t/((this._options.width+1)*Math.sqrt(3))-1,o=i/(2+1.5*(this._options.height-1)),r=Math.min(e,o),n=this._context.font;this._context.font="100px "+this._options.fontFamily;var s=Math.ceil(this._context.measureText("W").width);this._context.font=n;var a=s/100;r=Math.floor(r)+1;var h=2*r/(this._options.spacing*(1+a/Math.sqrt(3)));return Math.ceil(h)-1},ROT.Display.Hex.prototype.eventToPosition=function(t,i){if(this._options.transpose){t+=i,i=t-i,t-=i;var e="width"}else var e="height";var o=this._context.canvas[e]/this._options[e];return i=Math.floor(i/o),i.mod(2)?(t-=this._spacingX,t=1+2*Math.floor(t/(2*this._spacingX))):t=2*Math.floor(t/(2*this._spacingX)),[t,i]},ROT.Display.Hex.prototype._fill=function(t,i){var e=this._hexSize,o=this._options.border;this._context.beginPath(),this._options.transpose?(this._context.moveTo(t-e+o,i),this._context.lineTo(t-e/2+o,i+this._spacingX-o),this._context.lineTo(t+e/2-o,i+this._spacingX-o),this._context.lineTo(t+e-o,i),this._context.lineTo(t+e/2-o,i-this._spacingX+o),this._context.lineTo(t-e/2+o,i-this._spacingX+o),this._context.lineTo(t-e+o,i)):(this._context.moveTo(t,i-e+o),this._context.lineTo(t+this._spacingX-o,i-e/2+o),this._context.lineTo(t+this._spacingX-o,i+e/2-o),this._context.lineTo(t,i+e-o),this._context.lineTo(t-this._spacingX+o,i+e/2-o),this._context.lineTo(t-this._spacingX+o,i-e/2+o),this._context.lineTo(t,i-e+o)),this._context.fill()},ROT.Display.Tile=function(t){ROT.Display.Rect.call(this,t),this._options={},this._colorCanvas=document.createElement("canvas")},ROT.Display.Tile.extend(ROT.Display.Rect),ROT.Display.Tile.prototype.compute=function(t){this._options=t,this._context.canvas.width=t.width*t.tileWidth,this._context.canvas.height=t.height*t.tileHeight,this._colorCanvas.width=t.tileWidth,this._colorCanvas.height=t.tileHeight},ROT.Display.Tile.prototype.draw=function(t,i){var e=t[0],o=t[1],r=t[2],n=t[3],s=t[4],a=this._options.tileWidth,h=this._options.tileHeight;if(i&&(this._options.tileColorize?this._context.clearRect(e*a,o*h,a,h):(this._context.fillStyle=s,this._context.fillRect(e*a,o*h,a,h))),r)for(var l=[].concat(r),c=0;c<l.length;c++){var p=this._options.tileMap[l[c]];if(!p)throw new Error("Char '"+l[c]+"' not found in tileMap");if(this._options.tileColorize){var _=this._colorCanvas,u=_.getContext("2d");u.clearRect(0,0,a,h),u.drawImage(this._options.tileSet,p[0],p[1],a,h,0,0,a,h),"transparent"!=n&&(u.fillStyle=n,u.globalCompositeOperation="source-atop",u.fillRect(0,0,a,h)),"transparent"!=s&&(u.fillStyle=s,u.globalCompositeOperation="destination-over",u.fillRect(0,0,a,h)),this._context.drawImage(_,e*a,o*h,a,h)}else this._context.drawImage(this._options.tileSet,p[0],p[1],a,h,e*a,o*h,a,h)}},ROT.Display.Tile.prototype.computeSize=function(t,i){var e=Math.floor(t/this._options.tileWidth),o=Math.floor(i/this._options.tileHeight);return[e,o]},ROT.Display.Tile.prototype.computeFontSize=function(t,i){var e=Math.floor(t/this._options.width),o=Math.floor(i/this._options.height);return[e,o]},ROT.Display.Tile.prototype.eventToPosition=function(t,i){return[Math.floor(t/this._options.tileWidth),Math.floor(i/this._options.tileHeight)]},ROT.RNG={getSeed:function(){return this._seed},setSeed:function(t){return t=1>t?1/t:t,this._seed=t,this._s0=(t>>>0)*this._frac,t=69069*t+1>>>0,this._s1=t*this._frac,t=69069*t+1>>>0,this._s2=t*this._frac,this._c=1,this},getUniform:function(){var t=2091639*this._s0+this._c*this._frac;return this._s0=this._s1,this._s1=this._s2,this._c=0|t,this._s2=t-this._c,this._s2},getUniformInt:function(t,i){var e=Math.max(t,i),o=Math.min(t,i);return Math.floor(this.getUniform()*(e-o+1))+o},getNormal:function(t,i){do var e=2*this.getUniform()-1,o=2*this.getUniform()-1,r=e*e+o*o;while(r>1||0==r);var n=e*Math.sqrt(-2*Math.log(r)/r);return(t||0)+n*(i||1)},getPercentage:function(){return 1+Math.floor(100*this.getUniform())},getWeightedValue:function(t){var i=0;for(var e in t)i+=t[e];var o=this.getUniform()*i,r=0;for(var e in t)if(r+=t[e],r>o)return e;return e},getState:function(){return[this._s0,this._s1,this._s2,this._c]},setState:function(t){return this._s0=t[0],this._s1=t[1],this._s2=t[2],this._c=t[3],this},clone:function(){var t=Object.create(this);return t.setState(this.getState()),t},_s0:0,_s1:0,_s2:0,_c:0,_frac:2.3283064365386963e-10},ROT.RNG.setSeed(Date.now()),ROT.StringGenerator=function(t){this._options={words:!1,order:3,prior:.001};for(var i in t)this._options[i]=t[i];this._boundary=String.fromCharCode(0),this._suffix=this._boundary,this._prefix=[];for(var e=0;e<this._options.order;e++)this._prefix.push(this._boundary);this._priorValues={},this._priorValues[this._boundary]=this._options.prior,this._data={}},ROT.StringGenerator.prototype.clear=function(){this._data={},this._priorValues={}},ROT.StringGenerator.prototype.generate=function(){for(var t=[this._sample(this._prefix)];t[t.length-1]!=this._boundary;)t.push(this._sample(t));return this._join(t.slice(0,-1))},ROT.StringGenerator.prototype.observe=function(t){for(var i=this._split(t),e=0;e<i.length;e++)this._priorValues[i[e]]=this._options.prior;i=this._prefix.concat(i).concat(this._suffix);for(var e=this._options.order;e<i.length;e++)for(var o=i.slice(e-this._options.order,e),r=i[e],n=0;n<o.length;n++){var s=o.slice(n);this._observeEvent(s,r)}},ROT.StringGenerator.prototype.getStats=function(){var t=[],i=0;for(var e in this._priorValues)i++;i--,t.push("distinct samples: "+i);var o=0,r=0;for(var e in this._data){o++;for(var n in this._data[e])r++}return t.push("dictionary size (contexts): "+o),t.push("dictionary size (events): "+r),t.join(", ")},ROT.StringGenerator.prototype._split=function(t){return t.split(this._options.words?/\s+/:"")},ROT.StringGenerator.prototype._join=function(t){return t.join(this._options.words?" ":"")},ROT.StringGenerator.prototype._observeEvent=function(t,i){var e=this._join(t);e in this._data||(this._data[e]={});var o=this._data[e];i in o||(o[i]=0),o[i]++},ROT.StringGenerator.prototype._sample=function(t){t=this._backoff(t);var i=this._join(t),e=this._data[i],o={};if(this._options.prior){for(var r in this._priorValues)o[r]=this._priorValues[r];for(var r in e)o[r]+=e[r]}else o=e;return ROT.RNG.getWeightedValue(o)},ROT.StringGenerator.prototype._backoff=function(t){for(t.length>this._options.order?t=t.slice(-this._options.order):t.length<this._options.order&&(t=this._prefix.slice(0,this._options.order-t.length).concat(t));!(this._join(t)in this._data)&&t.length>0;)t=t.slice(1);return t},ROT.EventQueue=function(){this._time=0,this._events=[],this._eventTimes=[]},ROT.EventQueue.prototype.getTime=function(){return this._time},ROT.EventQueue.prototype.clear=function(){return this._events=[],this._eventTimes=[],this},ROT.EventQueue.prototype.add=function(t,i){for(var e=this._events.length,o=0;o<this._eventTimes.length;o++)if(this._eventTimes[o]>i){e=o;break}this._events.splice(e,0,t),this._eventTimes.splice(e,0,i)},ROT.EventQueue.prototype.get=function(){if(!this._events.length)return null;var t=this._eventTimes.splice(0,1)[0];if(t>0){this._time+=t;for(var i=0;i<this._eventTimes.length;i++)this._eventTimes[i]-=t}return this._events.splice(0,1)[0]},ROT.EventQueue.prototype.remove=function(t){var i=this._events.indexOf(t);return-1==i?!1:(this._remove(i),!0)},ROT.EventQueue.prototype._remove=function(t){this._events.splice(t,1),this._eventTimes.splice(t,1)},ROT.Scheduler=function(){this._queue=new ROT.EventQueue,this._repeat=[],this._current=null},ROT.Scheduler.prototype.getTime=function(){return this._queue.getTime()},ROT.Scheduler.prototype.add=function(t,i){return i&&this._repeat.push(t),this},ROT.Scheduler.prototype.clear=function(){return this._queue.clear(),this._repeat=[],this._current=null,this},ROT.Scheduler.prototype.remove=function(t){var i=this._queue.remove(t),e=this._repeat.indexOf(t);return-1!=e&&this._repeat.splice(e,1),this._current==t&&(this._current=null),i},ROT.Scheduler.prototype.next=function(){return this._current=this._queue.get(),this._current},ROT.Scheduler.Simple=function(){ROT.Scheduler.call(this)},ROT.Scheduler.Simple.extend(ROT.Scheduler),ROT.Scheduler.Simple.prototype.add=function(t,i){return this._queue.add(t,0),ROT.Scheduler.prototype.add.call(this,t,i)},ROT.Scheduler.Simple.prototype.next=function(){return this._current&&-1!=this._repeat.indexOf(this._current)&&this._queue.add(this._current,0),ROT.Scheduler.prototype.next.call(this)},ROT.Scheduler.Speed=function(){ROT.Scheduler.call(this)},ROT.Scheduler.Speed.extend(ROT.Scheduler),ROT.Scheduler.Speed.prototype.add=function(t,i){return this._queue.add(t,1/t.getSpeed()),ROT.Scheduler.prototype.add.call(this,t,i)},ROT.Scheduler.Speed.prototype.next=function(){return this._current&&-1!=this._repeat.indexOf(this._current)&&this._queue.add(this._current,1/this._current.getSpeed()),ROT.Scheduler.prototype.next.call(this)},ROT.Scheduler.Action=function(){ROT.Scheduler.call(this),this._defaultDuration=1,this._duration=this._defaultDuration},ROT.Scheduler.Action.extend(ROT.Scheduler),ROT.Scheduler.Action.prototype.add=function(t,i,e){return this._queue.add(t,e||this._defaultDuration),ROT.Scheduler.prototype.add.call(this,t,i)},ROT.Scheduler.Action.prototype.clear=function(){return this._duration=this._defaultDuration,ROT.Scheduler.prototype.clear.call(this)},ROT.Scheduler.Action.prototype.remove=function(t){return t==this._current&&(this._duration=this._defaultDuration),ROT.Scheduler.prototype.remove.call(this,t)},ROT.Scheduler.Action.prototype.next=function(){return this._current&&-1!=this._repeat.indexOf(this._current)&&(this._queue.add(this._current,this._duration||this._defaultDuration),this._duration=this._defaultDuration),ROT.Scheduler.prototype.next.call(this)},ROT.Scheduler.Action.prototype.setDuration=function(t){return this._current&&(this._duration=t),this},ROT.Engine=function(t){this._scheduler=t,this._lock=1},ROT.Engine.prototype.start=function(){return this.unlock()},ROT.Engine.prototype.lock=function(){return this._lock++,this},ROT.Engine.prototype.unlock=function(){if(!this._lock)throw new Error("Cannot unlock unlocked engine");for(this._lock--;!this._lock;){var t=this._scheduler.next();if(!t)return this.lock();var i=t.act();i&&i.then&&(this.lock(),i.then(this.unlock.bind(this)))}return this},ROT.Map=function(t,i){this._width=t||ROT.DEFAULT_WIDTH,this._height=i||ROT.DEFAULT_HEIGHT},ROT.Map.prototype.create=function(){},ROT.Map.prototype._fillMap=function(t){for(var i=[],e=0;e<this._width;e++){i.push([]);for(var o=0;o<this._height;o++)i[e].push(t)}return i},ROT.Map.Arena=function(t,i){ROT.Map.call(this,t,i)},ROT.Map.Arena.extend(ROT.Map),ROT.Map.Arena.prototype.create=function(t){for(var i=this._width-1,e=this._height-1,o=0;i>=o;o++)for(var r=0;e>=r;r++){var n=o&&r&&i>o&&e>r;t(o,r,n?0:1)}return this},ROT.Map.DividedMaze=function(t,i){ROT.Map.call(this,t,i),this._stack=[]},ROT.Map.DividedMaze.extend(ROT.Map),ROT.Map.DividedMaze.prototype.create=function(t){var i=this._width,e=this._height;this._map=[];for(var o=0;i>o;o++){this._map.push([]);for(var r=0;e>r;r++){var n=0==o||0==r||o+1==i||r+1==e;this._map[o].push(n?1:0)}}this._stack=[[1,1,i-2,e-2]],this._process();for(var o=0;i>o;o++)for(var r=0;e>r;r++)t(o,r,this._map[o][r]);return this._map=null,this},ROT.Map.DividedMaze.prototype._process=function(){for(;this._stack.length;){var t=this._stack.shift();this._partitionRoom(t)}},ROT.Map.DividedMaze.prototype._partitionRoom=function(t){for(var i=[],e=[],o=t[0]+1;o<t[2];o++){var r=this._map[o][t[1]-1],n=this._map[o][t[3]+1];!r||!n||o%2||i.push(o)}for(var s=t[1]+1;s<t[3];s++){var a=this._map[t[0]-1][s],h=this._map[t[2]+1][s];!a||!h||s%2||e.push(s)}if(i.length&&e.length){var l=i.random(),c=e.random();this._map[l][c]=1;var p=[],_=[];p.push(_);for(var o=t[0];l>o;o++)this._map[o][c]=1,_.push([o,c]);var _=[];p.push(_);for(var o=l+1;o<=t[2];o++)this._map[o][c]=1,_.push([o,c]);var _=[];p.push(_);for(var s=t[1];c>s;s++)this._map[l][s]=1,_.push([l,s]);var _=[];p.push(_);for(var s=c+1;s<=t[3];s++)this._map[l][s]=1,_.push([l,s]);for(var u=p.random(),o=0;o<p.length;o++){var _=p[o];if(_!=u){var f=_.random();this._map[f[0]][f[1]]=0}}this._stack.push([t[0],t[1],l-1,c-1]),this._stack.push([l+1,t[1],t[2],c-1]),this._stack.push([t[0],c+1,l-1,t[3]]),this._stack.push([l+1,c+1,t[2],t[3]])}},ROT.Map.IceyMaze=function(t,i,e){ROT.Map.call(this,t,i),this._regularity=e||0},ROT.Map.IceyMaze.extend(ROT.Map),ROT.Map.IceyMaze.prototype.create=function(t){var i=this._width,e=this._height,o=this._fillMap(1);i-=i%2?1:2,e-=e%2?1:2;var r=0,n=0,s=0,a=0,h=0,l=!1,c=[[0,0],[0,0],[0,0],[0,0]];do if(r=1+2*Math.floor(ROT.RNG.getUniform()*(i-1)/2),n=1+2*Math.floor(ROT.RNG.getUniform()*(e-1)/2),h||(o[r][n]=0),!o[r][n]){this._randomize(c);do{0==Math.floor(ROT.RNG.getUniform()*(this._regularity+1))&&this._randomize(c),l=!0;for(var p=0;4>p;p++)if(s=r+2*c[p][0],a=n+2*c[p][1],this._isFree(o,s,a,i,e)){o[s][a]=0,o[r+c[p][0]][n+c[p][1]]=0,r=s,n=a,l=!1,h++;break}}while(!l)}while(i*e/4>h+1);for(var p=0;p<this._width;p++)for(var _=0;_<this._height;_++)t(p,_,o[p][_]);return this._map=null,this},ROT.Map.IceyMaze.prototype._randomize=function(t){for(var i=0;4>i;i++)t[i][0]=0,t[i][1]=0;switch(Math.floor(4*ROT.RNG.getUniform())){case 0:t[0][0]=-1,t[1][0]=1,t[2][1]=-1,t[3][1]=1;break;case 1:t[3][0]=-1,t[2][0]=1,t[1][1]=-1,t[0][1]=1;break;case 2:t[2][0]=-1,t[3][0]=1,t[0][1]=-1,t[1][1]=1;break;case 3:t[1][0]=-1,t[0][0]=1,t[3][1]=-1,t[2][1]=1}},ROT.Map.IceyMaze.prototype._isFree=function(t,i,e,o,r){return 1>i||1>e||i>=o||e>=r?!1:t[i][e]},ROT.Map.EllerMaze=function(t,i){ROT.Map.call(this,t,i)},ROT.Map.EllerMaze.extend(ROT.Map),ROT.Map.EllerMaze.prototype.create=function(t){for(var i=this._fillMap(1),e=Math.ceil((this._width-2)/2),o=.375,r=[],n=[],s=0;e>s;s++)r.push(s),n.push(s);r.push(e-1);for(var a=1;a+3<this._height;a+=2)for(var s=0;e>s;s++){var h=2*s+1,l=a;i[h][l]=0,s!=r[s+1]&&ROT.RNG.getUniform()>o&&(this._addToList(s,r,n),i[h+1][l]=0),s!=r[s]&&ROT.RNG.getUniform()>o?this._removeFromList(s,r,n):i[h][l+1]=0}for(var s=0;e>s;s++){var h=2*s+1,l=a;i[h][l]=0,s!=r[s+1]&&(s==r[s]||ROT.RNG.getUniform()>o)&&(this._addToList(s,r,n),i[h+1][l]=0),this._removeFromList(s,r,n)}for(var s=0;s<this._width;s++)for(var a=0;a<this._height;a++)t(s,a,i[s][a]);return this},ROT.Map.EllerMaze.prototype._removeFromList=function(t,i,e){e[i[t]]=e[t],i[e[t]]=i[t],e[t]=t,i[t]=t},ROT.Map.EllerMaze.prototype._addToList=function(t,i,e){e[i[t+1]]=e[t],i[e[t]]=i[t+1],e[t]=t+1,i[t+1]=t},ROT.Map.Cellular=function(t,i,e){ROT.Map.call(this,t,i),this._options={born:[5,6,7,8],survive:[4,5,6,7,8],topology:8,connected:!1},this.setOptions(e),this._dirs=ROT.DIRS[this._options.topology],this._map=this._fillMap(0)},ROT.Map.Cellular.extend(ROT.Map),ROT.Map.Cellular.prototype.randomize=function(t){for(var i=0;i<this._width;i++)for(var e=0;e<this._height;e++)this._map[i][e]=ROT.RNG.getUniform()<t?1:0;return this},ROT.Map.Cellular.prototype.setOptions=function(t){for(var i in t)this._options[i]=t[i]},ROT.Map.Cellular.prototype.set=function(t,i,e){this._map[t][i]=e},ROT.Map.Cellular.prototype.create=function(t){for(var i=this._fillMap(0),e=this._options.born,o=this._options.survive,r=0;r<this._height;r++){var n=1,s=0;6==this._options.topology&&(n=2,s=r%2);for(var a=s;a<this._width;a+=n){var h=this._map[a][r],l=this._getNeighbors(a,r);h&&-1!=o.indexOf(l)?i[a][r]=1:h||-1==e.indexOf(l)||(i[a][r]=1)}}if(this._map=i,this._options.connected&&this._completeMaze(),t)for(var r=0;r<this._height;r++){var n=1,s=0;6==this._options.topology&&(n=2,s=r%2);for(var a=s;a<this._width;a+=n)t(a,r,i[a][r])}},ROT.Map.Cellular.prototype._getNeighbors=function(t,i){for(var e=0,o=0;o<this._dirs.length;o++){var r=this._dirs[o],n=t+r[0],s=i+r[1];0>n||n>=this._width||0>n||s>=this._width||(e+=1==this._map[n][s]?1:0)}return e},ROT.Map.Cellular.prototype._completeMaze=function(){for(var t=[],i={},e=0;e<this._width;e++)for(var o=0;o<this._height;o++)if(this._freeSpace(e,o)){var r=[e,o];i[this._pointKey(r)]=r,t.push([e,o])}var n=t[ROT.RNG.getUniformInt(0,t.length-1)],s=this._pointKey(n),a={};for(a[s]=n,delete i[s],this._findConnected(a,i,[n]);Object.keys(i).length>0;){var r=this._getFromTo(a,i),h=r[0],l=r[1],c={};c[this._pointKey(h)]=h,this._findConnected(c,i,[h],!0),this._tunnelToConnected(l,h,a,i);for(var p in c){var _=c[p];this._map[_[0]][_[1]]=0,a[p]=_,delete i[p]}}},ROT.Map.Cellular.prototype._getFromTo=function(t,i){for(var e,o,r,n=Object.keys(t),s=Object.keys(i),a=0;5>a;a++){if(n.length<s.length){var h=n;o=t[h[ROT.RNG.getUniformInt(0,h.length-1)]],e=this._getClosest(o,i)}else{var h=s;e=i[h[ROT.RNG.getUniformInt(0,h.length-1)]],o=this._getClosest(e,t)}if(r=(e[0]-o[0])*(e[0]-o[0])+(e[1]-o[1])*(e[1]-o[1]),64>r)break}return[e,o]},ROT.Map.Cellular.prototype._getClosest=function(t,i){var e=null,o=null;for(k in i){var r=i[k],n=(r[0]-t[0])*(r[0]-t[0])+(r[1]-t[1])*(r[1]-t[1]);(null==o||o>n)&&(o=n,e=r)}return e},ROT.Map.Cellular.prototype._findConnected=function(t,i,e,o){for(;e.length>0;)for(var r=e.splice(0,1)[0],n=[[r[0]+1,r[1]],[r[0]-1,r[1]],[r[0],r[1]+1],[r[0],r[1]-1]],s=0;s<n.length;s++){var a=this._pointKey(n[s]);null==t[a]&&this._freeSpace(n[s][0],n[s][1])&&(t[a]=n[s],o||delete i[a],e.push(n[s]))}},ROT.Map.Cellular.prototype._tunnelToConnected=function(t,i,e,o){{var r,n;this._pointKey(i)}i[0]<t[0]?(r=i,n=t):(r=t,n=i);for(var s=r[0];s<=n[0];s++){this._map[s][r[1]]=0;var a=[s,r[1]],h=this._pointKey(a);e[h]=a,delete o[h]}var l=n[0];i[1]<t[1]?(r=i,n=t):(r=t,n=i);for(var c=r[1];c<n[1];c++){this._map[l][c]=0;var a=[l,c],h=this._pointKey(a);e[h]=a,delete o[h]}},ROT.Map.Cellular.prototype._freeSpace=function(t,i){return t>=0&&t<this._width&&i>=0&&i<this._height&&1!=this._map[t][i]},ROT.Map.Cellular.prototype._pointKey=function(t){return t[0]+"."+t[1]},ROT.Map.Dungeon=function(t,i){ROT.Map.call(this,t,i),this._rooms=[],this._corridors=[]},ROT.Map.Dungeon.extend(ROT.Map),ROT.Map.Dungeon.prototype.getRooms=function(){return this._rooms},ROT.Map.Dungeon.prototype.getCorridors=function(){return this._corridors},ROT.Map.Digger=function(t,i,e){ROT.Map.Dungeon.call(this,t,i),this._options={roomWidth:[3,9],roomHeight:[3,5],corridorLength:[3,10],dugPercentage:.2,timeLimit:1e3};for(var o in e)this._options[o]=e[o];this._features={Room:4,Corridor:4},this._featureAttempts=20,this._walls={},this._digCallback=this._digCallback.bind(this),this._canBeDugCallback=this._canBeDugCallback.bind(this),this._isWallCallback=this._isWallCallback.bind(this),this._priorityWallCallback=this._priorityWallCallback.bind(this)
},ROT.Map.Digger.extend(ROT.Map.Dungeon),ROT.Map.Digger.prototype.create=function(t){this._rooms=[],this._corridors=[],this._map=this._fillMap(1),this._walls={},this._dug=0;var i=(this._width-2)*(this._height-2);this._firstRoom();var e=Date.now();do{var o=Date.now();if(o-e>this._options.timeLimit)break;var r=this._findWall();if(!r)break;var n=r.split(","),s=parseInt(n[0]),a=parseInt(n[1]),h=this._getDiggingDirection(s,a);if(h){var l=0;do if(l++,this._tryFeature(s,a,h[0],h[1])){this._removeSurroundingWalls(s,a),this._removeSurroundingWalls(s-h[0],a-h[1]);break}while(l<this._featureAttempts);var c=0;for(var p in this._walls)this._walls[p]>1&&c++}}while(this._dug/i<this._options.dugPercentage||c);if(this._addDoors(),t)for(var _=0;_<this._width;_++)for(var u=0;u<this._height;u++)t(_,u,this._map[_][u]);return this._walls={},this._map=null,this},ROT.Map.Digger.prototype._digCallback=function(t,i,e){0==e||2==e?(this._map[t][i]=0,this._dug++):this._walls[t+","+i]=1},ROT.Map.Digger.prototype._isWallCallback=function(t,i){return 0>t||0>i||t>=this._width||i>=this._height?!1:1==this._map[t][i]},ROT.Map.Digger.prototype._canBeDugCallback=function(t,i){return 1>t||1>i||t+1>=this._width||i+1>=this._height?!1:1==this._map[t][i]},ROT.Map.Digger.prototype._priorityWallCallback=function(t,i){this._walls[t+","+i]=2},ROT.Map.Digger.prototype._firstRoom=function(){var t=Math.floor(this._width/2),i=Math.floor(this._height/2),e=ROT.Map.Feature.Room.createRandomCenter(t,i,this._options);this._rooms.push(e),e.create(this._digCallback)},ROT.Map.Digger.prototype._findWall=function(){var t=[],i=[];for(var e in this._walls){var o=this._walls[e];2==o?i.push(e):t.push(e)}var r=i.length?i:t;if(!r.length)return null;var e=r.random();return delete this._walls[e],e},ROT.Map.Digger.prototype._tryFeature=function(t,i,e,o){var r=ROT.RNG.getWeightedValue(this._features);return r=ROT.Map.Feature[r].createRandomAt(t,i,e,o,this._options),r.isValid(this._isWallCallback,this._canBeDugCallback)?(r.create(this._digCallback),r instanceof ROT.Map.Feature.Room&&this._rooms.push(r),r instanceof ROT.Map.Feature.Corridor&&(r.createPriorityWalls(this._priorityWallCallback),this._corridors.push(r)),!0):!1},ROT.Map.Digger.prototype._removeSurroundingWalls=function(t,i){for(var e=ROT.DIRS[4],o=0;o<e.length;o++){var r=e[o],n=t+r[0],s=i+r[1];delete this._walls[n+","+s];var n=t+2*r[0],s=i+2*r[1];delete this._walls[n+","+s]}},ROT.Map.Digger.prototype._getDiggingDirection=function(t,i){if(0>=t||0>=i||t>=this._width-1||i>=this._height-1)return null;for(var e=null,o=ROT.DIRS[4],r=0;r<o.length;r++){var n=o[r],s=t+n[0],a=i+n[1];if(!this._map[s][a]){if(e)return null;e=n}}return e?[-e[0],-e[1]]:null},ROT.Map.Digger.prototype._addDoors=function(){for(var t=this._map,i=function(i,e){return 1==t[i][e]},e=0;e<this._rooms.length;e++){var o=this._rooms[e];o.clearDoors(),o.addDoors(i)}},ROT.Map.Uniform=function(t,i,e){ROT.Map.Dungeon.call(this,t,i),this._options={roomWidth:[3,9],roomHeight:[3,5],roomDugPercentage:.1,timeLimit:1e3};for(var o in e)this._options[o]=e[o];this._roomAttempts=20,this._corridorAttempts=20,this._connected=[],this._unconnected=[],this._digCallback=this._digCallback.bind(this),this._canBeDugCallback=this._canBeDugCallback.bind(this),this._isWallCallback=this._isWallCallback.bind(this)},ROT.Map.Uniform.extend(ROT.Map.Dungeon),ROT.Map.Uniform.prototype.create=function(t){for(var i=Date.now();;){var e=Date.now();if(e-i>this._options.timeLimit)return null;if(this._map=this._fillMap(1),this._dug=0,this._rooms=[],this._unconnected=[],this._generateRooms(),!(this._rooms.length<2)&&this._generateCorridors())break}if(t)for(var o=0;o<this._width;o++)for(var r=0;r<this._height;r++)t(o,r,this._map[o][r]);return this},ROT.Map.Uniform.prototype._generateRooms=function(){var t=this._width-2,i=this._height-2;do{var e=this._generateRoom();if(this._dug/(t*i)>this._options.roomDugPercentage)break}while(e)},ROT.Map.Uniform.prototype._generateRoom=function(){for(var t=0;t<this._roomAttempts;){t++;var i=ROT.Map.Feature.Room.createRandom(this._width,this._height,this._options);if(i.isValid(this._isWallCallback,this._canBeDugCallback))return i.create(this._digCallback),this._rooms.push(i),i}return null},ROT.Map.Uniform.prototype._generateCorridors=function(){for(var t=0;t<this._corridorAttempts;){t++,this._corridors=[],this._map=this._fillMap(1);for(var i=0;i<this._rooms.length;i++){var e=this._rooms[i];e.clearDoors(),e.create(this._digCallback)}for(this._unconnected=this._rooms.slice().randomize(),this._connected=[],this._unconnected.length&&this._connected.push(this._unconnected.pop());;){var o=this._connected.random(),r=this._closestRoom(this._unconnected,o),n=this._closestRoom(this._connected,r),s=this._connectRooms(r,n);if(!s)break;if(!this._unconnected.length)return!0}}return!1},ROT.Map.Uniform.prototype._closestRoom=function(t,i){for(var e=1/0,o=i.getCenter(),r=null,n=0;n<t.length;n++){var s=t[n],a=s.getCenter(),h=a[0]-o[0],l=a[1]-o[1],c=h*h+l*l;e>c&&(e=c,r=s)}return r},ROT.Map.Uniform.prototype._connectRooms=function(t,i){var e=t.getCenter(),o=i.getCenter(),r=o[0]-e[0],n=o[1]-e[1];if(Math.abs(r)<Math.abs(n))var s=n>0?2:0,a=(s+2)%4,h=i.getLeft(),l=i.getRight(),c=0;else var s=r>0?1:3,a=(s+2)%4,h=i.getTop(),l=i.getBottom(),c=1;var p=this._placeInWall(t,s);if(!p)return!1;if(p[c]>=h&&p[c]<=l){var _=p.slice(),u=null;switch(a){case 0:u=i.getTop()-1;break;case 1:u=i.getRight()+1;break;case 2:u=i.getBottom()+1;break;case 3:u=i.getLeft()-1}_[(c+1)%2]=u,this._digLine([p,_])}else if(p[c]<h-1||p[c]>l+1){var f=p[c]-o[c];switch(a){case 0:case 1:var d=0>f?3:1;break;case 2:case 3:var d=0>f?1:3}a=(a+d)%4;var _=this._placeInWall(i,a);if(!_)return!1;var g=[0,0];g[c]=p[c];var R=(c+1)%2;g[R]=_[R],this._digLine([p,g,_])}else{var R=(c+1)%2,_=this._placeInWall(i,a);if(!_)return!1;var g=Math.round((_[R]+p[R])/2),T=[0,0],v=[0,0];T[c]=p[c],T[R]=g,v[c]=_[c],v[R]=g,this._digLine([p,T,v,_])}t.addDoor(p[0],p[1]),i.addDoor(_[0],_[1]);var c=this._unconnected.indexOf(t);-1!=c&&(this._unconnected.splice(c,1),this._connected.push(t));var c=this._unconnected.indexOf(i);return-1!=c&&(this._unconnected.splice(c,1),this._connected.push(i)),!0},ROT.Map.Uniform.prototype._placeInWall=function(t,i){var e=[0,0],o=[0,0],r=0;switch(i){case 0:o=[1,0],e=[t.getLeft(),t.getTop()-1],r=t.getRight()-t.getLeft()+1;break;case 1:o=[0,1],e=[t.getRight()+1,t.getTop()],r=t.getBottom()-t.getTop()+1;break;case 2:o=[1,0],e=[t.getLeft(),t.getBottom()+1],r=t.getRight()-t.getLeft()+1;break;case 3:o=[0,1],e=[t.getLeft()-1,t.getTop()],r=t.getBottom()-t.getTop()+1}for(var n=[],s=-2,a=0;r>a;a++){var h=e[0]+a*o[0],l=e[1]+a*o[1];n.push(null);var c=1==this._map[h][l];c?s!=a-1&&(n[a]=[h,l]):(s=a,a&&(n[a-1]=null))}for(var a=n.length-1;a>=0;a--)n[a]||n.splice(a,1);return n.length?n.random():null},ROT.Map.Uniform.prototype._digLine=function(t){for(var i=1;i<t.length;i++){var e=t[i-1],o=t[i],r=new ROT.Map.Feature.Corridor(e[0],e[1],o[0],o[1]);r.create(this._digCallback),this._corridors.push(r)}},ROT.Map.Uniform.prototype._digCallback=function(t,i,e){this._map[t][i]=e,0==e&&this._dug++},ROT.Map.Uniform.prototype._isWallCallback=function(t,i){return 0>t||0>i||t>=this._width||i>=this._height?!1:1==this._map[t][i]},ROT.Map.Uniform.prototype._canBeDugCallback=function(t,i){return 1>t||1>i||t+1>=this._width||i+1>=this._height?!1:1==this._map[t][i]},ROT.Map.Rogue=function(t,i,e){ROT.Map.call(this,t,i),this._options={cellWidth:3,cellHeight:3};for(var o in e)this._options[o]=e[o];this._options.hasOwnProperty("roomWidth")||(this._options.roomWidth=this._calculateRoomSize(this._width,this._options.cellWidth)),this._options.hasOwnProperty("roomHeight")||(this._options.roomHeight=this._calculateRoomSize(this._height,this._options.cellHeight))},ROT.Map.Rogue.extend(ROT.Map),ROT.Map.Rogue.prototype.create=function(t){if(this.map=this._fillMap(1),this.rooms=[],this.connectedCells=[],this._initRooms(),this._connectRooms(),this._connectUnconnectedRooms(),this._createRandomRoomConnections(),this._createRooms(),this._createCorridors(),t)for(var i=0;i<this._width;i++)for(var e=0;e<this._height;e++)t(i,e,this.map[i][e]);return this},ROT.Map.Rogue.prototype._calculateRoomSize=function(t,i){var e=Math.floor(t/i*.8),o=Math.floor(t/i*.25);return 2>o&&(o=2),2>e&&(e=2),[o,e]},ROT.Map.Rogue.prototype._initRooms=function(){for(var t=0;t<this._options.cellWidth;t++){this.rooms.push([]);for(var i=0;i<this._options.cellHeight;i++)this.rooms[t].push({x:0,y:0,width:0,height:0,connections:[],cellx:t,celly:i})}},ROT.Map.Rogue.prototype._connectRooms=function(){var t,i,e,o,r,n=ROT.RNG.getUniformInt(0,this._options.cellWidth-1),s=ROT.RNG.getUniformInt(0,this._options.cellHeight-1),a=!1;do{var h=[0,2,4,6];h=h.randomize();do if(a=!1,t=h.pop(),i=n+ROT.DIRS[8][t][0],e=s+ROT.DIRS[8][t][1],!(0>i||i>=this._options.cellWidth||0>e||e>=this._options.cellHeight)){if(o=this.rooms[n][s],o.connections.length>0&&o.connections[0][0]==i&&o.connections[0][1]==e)break;r=this.rooms[i][e],0==r.connections.length&&(r.connections.push([n,s]),this.connectedCells.push([i,e]),n=i,s=e,a=!0)}while(h.length>0&&0==a)}while(h.length>0)},ROT.Map.Rogue.prototype._connectUnconnectedRooms=function(){var t=this._options.cellWidth,i=this._options.cellHeight;this.connectedCells=this.connectedCells.randomize();for(var e,o,r,n=0;n<this._options.cellWidth;n++)for(var s=0;s<this._options.cellHeight;s++)if(e=this.rooms[n][s],0==e.connections.length){var a=[0,2,4,6];a=a.randomize();var r=!1;do{var h=a.pop(),l=n+ROT.DIRS[8][h][0],c=s+ROT.DIRS[8][h][1];if(!(0>l||l>=t||0>c||c>=i)){if(o=this.rooms[l][c],r=!0,0==o.connections.length)break;for(var p=0;p<o.connections.length;p++)if(o.connections[p][0]==n&&o.connections[p][1]==s){r=!1;break}if(r)break}}while(a.length);r?e.connections.push([o.cellx,o.celly]):console.log("-- Unable to connect room.")}},ROT.Map.Rogue.prototype._createRandomRoomConnections=function(){},ROT.Map.Rogue.prototype._createRooms=function(){for(var t,i,e,o,r,n=this._width,s=this._height,a=this._options.cellWidth,h=this._options.cellHeight,l=Math.floor(this._width/a),c=Math.floor(this._height/h),p=this._options.roomWidth,_=this._options.roomHeight,u=0;a>u;u++)for(var f=0;h>f;f++){if(e=l*u,o=c*f,0==e&&(e=1),0==o&&(o=1),t=ROT.RNG.getUniformInt(p[0],p[1]),i=ROT.RNG.getUniformInt(_[0],_[1]),f>0)for(r=this.rooms[u][f-1];o-(r.y+r.height)<3;)o++;if(u>0)for(r=this.rooms[u-1][f];e-(r.x+r.width)<3;)e++;for(var d=Math.round(ROT.RNG.getUniformInt(0,l-t)/2),g=Math.round(ROT.RNG.getUniformInt(0,c-i)/2);e+d+t>=n;)d?d--:t--;for(;o+g+i>=s;)g?g--:i--;e+=d,o+=g,this.rooms[u][f].x=e,this.rooms[u][f].y=o,this.rooms[u][f].width=t,this.rooms[u][f].height=i;for(var R=e;e+t>R;R++)for(var T=o;o+i>T;T++)this.map[R][T]=0}},ROT.Map.Rogue.prototype._getWallPosition=function(t,i){var e,o,r;return 1==i||3==i?(e=ROT.RNG.getUniformInt(t.x+1,t.x+t.width-2),1==i?(o=t.y-2,r=o+1):(o=t.y+t.height+1,r=o-1),this.map[e][r]=0):(2==i||4==i)&&(o=ROT.RNG.getUniformInt(t.y+1,t.y+t.height-2),2==i?(e=t.x+t.width+1,r=e-1):(e=t.x-2,r=e+1),this.map[r][o]=0),[e,o]},ROT.Map.Rogue.prototype._drawCorridore=function(t,i){var e,o,r,n,s=i[0]-t[0],a=i[1]-t[1],h=t[0],l=t[1],c=[],p=Math.abs(s),_=Math.abs(a),u=ROT.RNG.getUniform(),f=u,d=1-u;for(o=s>0?2:6,r=a>0?4:0,_>p?(e=Math.ceil(_*f),c.push([r,e]),c.push([o,p]),e=Math.floor(_*d),c.push([r,e])):(e=Math.ceil(p*f),c.push([o,e]),c.push([r,_]),e=Math.floor(p*d),c.push([o,e])),this.map[h][l]=0;c.length>0;)for(n=c.pop();n[1]>0;)h+=ROT.DIRS[8][n[0]][0],l+=ROT.DIRS[8][n[0]][1],this.map[h][l]=0,n[1]=n[1]-1},ROT.Map.Rogue.prototype._createCorridors=function(){for(var t,i,e,o,r,n=this._options.cellWidth,s=this._options.cellHeight,a=0;n>a;a++)for(var h=0;s>h;h++){t=this.rooms[a][h];for(var l=0;l<t.connections.length;l++)i=t.connections[l],e=this.rooms[i[0]][i[1]],e.cellx>t.cellx?(o=2,r=4):e.cellx<t.cellx?(o=4,r=2):e.celly>t.celly?(o=3,r=1):e.celly<t.celly&&(o=1,r=3),this._drawCorridore(this._getWallPosition(t,o),this._getWallPosition(e,r))}},ROT.Map.Feature=function(){},ROT.Map.Feature.prototype.isValid=function(){},ROT.Map.Feature.prototype.create=function(){},ROT.Map.Feature.prototype.debug=function(){},ROT.Map.Feature.createRandomAt=function(){},ROT.Map.Feature.Room=function(t,i,e,o,r,n){this._x1=t,this._y1=i,this._x2=e,this._y2=o,this._doors={},arguments.length>4&&this.addDoor(r,n)},ROT.Map.Feature.Room.extend(ROT.Map.Feature),ROT.Map.Feature.Room.createRandomAt=function(t,i,e,o,r){var n=r.roomWidth[0],s=r.roomWidth[1],a=ROT.RNG.getUniformInt(n,s),n=r.roomHeight[0],s=r.roomHeight[1],h=ROT.RNG.getUniformInt(n,s);if(1==e){var l=i-Math.floor(ROT.RNG.getUniform()*h);return new this(t+1,l,t+a,l+h-1,t,i)}if(-1==e){var l=i-Math.floor(ROT.RNG.getUniform()*h);return new this(t-a,l,t-1,l+h-1,t,i)}if(1==o){var c=t-Math.floor(ROT.RNG.getUniform()*a);return new this(c,i+1,c+a-1,i+h,t,i)}if(-1==o){var c=t-Math.floor(ROT.RNG.getUniform()*a);return new this(c,i-h,c+a-1,i-1,t,i)}throw new Error("dx or dy must be 1 or -1")},ROT.Map.Feature.Room.createRandomCenter=function(t,i,e){var o=e.roomWidth[0],r=e.roomWidth[1],n=ROT.RNG.getUniformInt(o,r),o=e.roomHeight[0],r=e.roomHeight[1],s=ROT.RNG.getUniformInt(o,r),a=t-Math.floor(ROT.RNG.getUniform()*n),h=i-Math.floor(ROT.RNG.getUniform()*s),l=a+n-1,c=h+s-1;return new this(a,h,l,c)},ROT.Map.Feature.Room.createRandom=function(t,i,e){var o=e.roomWidth[0],r=e.roomWidth[1],n=ROT.RNG.getUniformInt(o,r),o=e.roomHeight[0],r=e.roomHeight[1],s=ROT.RNG.getUniformInt(o,r),a=t-n-1,h=i-s-1,l=1+Math.floor(ROT.RNG.getUniform()*a),c=1+Math.floor(ROT.RNG.getUniform()*h),p=l+n-1,_=c+s-1;return new this(l,c,p,_)},ROT.Map.Feature.Room.prototype.addDoor=function(t,i){return this._doors[t+","+i]=1,this},ROT.Map.Feature.Room.prototype.getDoors=function(t){for(var i in this._doors){var e=i.split(",");t(parseInt(e[0]),parseInt(e[1]))}return this},ROT.Map.Feature.Room.prototype.clearDoors=function(){return this._doors={},this},ROT.Map.Feature.Room.prototype.addDoors=function(t){for(var i=this._x1-1,e=this._x2+1,o=this._y1-1,r=this._y2+1,n=i;e>=n;n++)for(var s=o;r>=s;s++)(n==i||n==e||s==o||s==r)&&(t(n,s)||this.addDoor(n,s));return this},ROT.Map.Feature.Room.prototype.debug=function(){console.log("room",this._x1,this._y1,this._x2,this._y2)},ROT.Map.Feature.Room.prototype.isValid=function(t,i){for(var e=this._x1-1,o=this._x2+1,r=this._y1-1,n=this._y2+1,s=e;o>=s;s++)for(var a=r;n>=a;a++)if(s==e||s==o||a==r||a==n){if(!t(s,a))return!1}else if(!i(s,a))return!1;return!0},ROT.Map.Feature.Room.prototype.create=function(t){for(var i=this._x1-1,e=this._x2+1,o=this._y1-1,r=this._y2+1,n=0,s=i;e>=s;s++)for(var a=o;r>=a;a++)n=s+","+a in this._doors?2:s==i||s==e||a==o||a==r?1:0,t(s,a,n)},ROT.Map.Feature.Room.prototype.getCenter=function(){return[Math.round((this._x1+this._x2)/2),Math.round((this._y1+this._y2)/2)]},ROT.Map.Feature.Room.prototype.getLeft=function(){return this._x1},ROT.Map.Feature.Room.prototype.getRight=function(){return this._x2},ROT.Map.Feature.Room.prototype.getTop=function(){return this._y1},ROT.Map.Feature.Room.prototype.getBottom=function(){return this._y2},ROT.Map.Feature.Corridor=function(t,i,e,o){this._startX=t,this._startY=i,this._endX=e,this._endY=o,this._endsWithAWall=!0},ROT.Map.Feature.Corridor.extend(ROT.Map.Feature),ROT.Map.Feature.Corridor.createRandomAt=function(t,i,e,o,r){var n=r.corridorLength[0],s=r.corridorLength[1],a=ROT.RNG.getUniformInt(n,s);return new this(t,i,t+e*a,i+o*a)},ROT.Map.Feature.Corridor.prototype.debug=function(){console.log("corridor",this._startX,this._startY,this._endX,this._endY)},ROT.Map.Feature.Corridor.prototype.isValid=function(t,i){var e=this._startX,o=this._startY,r=this._endX-e,n=this._endY-o,s=1+Math.max(Math.abs(r),Math.abs(n));r&&(r/=Math.abs(r)),n&&(n/=Math.abs(n));for(var a=n,h=-r,l=!0,c=0;s>c;c++){var p=e+c*r,_=o+c*n;if(i(p,_)||(l=!1),t(p+a,_+h)||(l=!1),t(p-a,_-h)||(l=!1),!l){s=c,this._endX=p-r,this._endY=_-n;break}}if(0==s)return!1;if(1==s&&t(this._endX+r,this._endY+n))return!1;var u=!t(this._endX+r+a,this._endY+n+h),f=!t(this._endX+r-a,this._endY+n-h);return this._endsWithAWall=t(this._endX+r,this._endY+n),(u||f)&&this._endsWithAWall?!1:!0},ROT.Map.Feature.Corridor.prototype.create=function(t){var i=this._startX,e=this._startY,o=this._endX-i,r=this._endY-e,n=1+Math.max(Math.abs(o),Math.abs(r));o&&(o/=Math.abs(o)),r&&(r/=Math.abs(r));for(var s=0;n>s;s++){var a=i+s*o,h=e+s*r;t(a,h,0)}return!0},ROT.Map.Feature.Corridor.prototype.createPriorityWalls=function(t){if(this._endsWithAWall){var i=this._startX,e=this._startY,o=this._endX-i,r=this._endY-e;o&&(o/=Math.abs(o)),r&&(r/=Math.abs(r));var n=r,s=-o;t(this._endX+o,this._endY+r),t(this._endX+n,this._endY+s),t(this._endX-n,this._endY-s)}},ROT.Noise=function(){},ROT.Noise.prototype.get=function(){},ROT.Noise.Simplex=function(t){ROT.Noise.call(this),this._F2=.5*(Math.sqrt(3)-1),this._G2=(3-Math.sqrt(3))/6,this._gradients=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]];for(var i=[],e=t||256,o=0;e>o;o++)i.push(o);i=i.randomize(),this._perms=[],this._indexes=[];for(var o=0;2*e>o;o++)this._perms.push(i[o%e]),this._indexes.push(this._perms[o]%this._gradients.length)},ROT.Noise.Simplex.extend(ROT.Noise),ROT.Noise.Simplex.prototype.get=function(t,i){var e,o,r,n=this._perms,s=this._indexes,a=n.length/2,h=this._G2,l=0,c=0,p=0,_=(t+i)*this._F2,u=Math.floor(t+_),f=Math.floor(i+_),d=(u+f)*h,g=u-d,R=f-d,T=t-g,v=i-R;T>v?(o=1,r=0):(o=0,r=1);var m=T-o+h,O=v-r+h,y=T-1+2*h,M=v-1+2*h,S=u.mod(a),b=f.mod(a),w=.5-T*T-v*v;if(w>=0){w*=w,e=s[S+n[b]];var x=this._gradients[e];l=w*w*(x[0]*T+x[1]*v)}var V=.5-m*m-O*O;if(V>=0){V*=V,e=s[S+o+n[b+r]];var x=this._gradients[e];c=V*V*(x[0]*m+x[1]*O)}var C=.5-y*y-M*M;if(C>=0){C*=C,e=s[S+1+n[b+1]];var x=this._gradients[e];p=C*C*(x[0]*y+x[1]*M)}return 70*(l+c+p)},ROT.FOV=function(t,i){this._lightPasses=t,this._options={topology:8};for(var e in i)this._options[e]=i[e]},ROT.FOV.prototype.compute=function(){},ROT.FOV.prototype._getCircle=function(t,i,e){var o,r,n,s=[];switch(this._options.topology){case 4:r=1,n=[0,1],o=[ROT.DIRS[8][7],ROT.DIRS[8][1],ROT.DIRS[8][3],ROT.DIRS[8][5]];break;case 6:o=ROT.DIRS[6],r=1,n=[-1,1];break;case 8:o=ROT.DIRS[4],r=2,n=[-1,1]}for(var a=t+n[0]*e,h=i+n[1]*e,l=0;l<o.length;l++)for(var c=0;e*r>c;c++)s.push([a,h]),a+=o[l][0],h+=o[l][1];return s},ROT.FOV.DiscreteShadowcasting=function(t,i){ROT.FOV.call(this,t,i)},ROT.FOV.DiscreteShadowcasting.extend(ROT.FOV),ROT.FOV.DiscreteShadowcasting.prototype.compute=function(t,i,e,o){this._coords,this._map;if(o(t,i,0,1),this._lightPasses(t,i))for(var r,n,s,a,h,l=[],c=1;e>=c;c++)for(var p=this._getCircle(t,i,c),_=360/p.length,u=0;u<p.length;u++)if(s=p[u][0],a=p[u][1],r=_*(u-.5),n=r+_,h=!this._lightPasses(s,a),this._visibleCoords(Math.floor(r),Math.ceil(n),h,l)&&o(s,a,c,1),2==l.length&&0==l[0]&&360==l[1])return},ROT.FOV.DiscreteShadowcasting.prototype._visibleCoords=function(t,i,e,o){if(0>t){var r=arguments.callee(0,i,e,o),n=arguments.callee(360+t,360,e,o);return r||n}for(var s=0;s<o.length&&o[s]<t;)s++;if(s==o.length)return e&&o.push(t,i),!0;var a=0;if(s%2){for(;s<o.length&&o[s]<i;)s++,a++;return 0==a?!1:(e&&(a%2?o.splice(s-a,a,i):o.splice(s-a,a)),!0)}for(;s<o.length&&o[s]<i;)s++,a++;return t==o[s-a]&&1==a?!1:(e&&(a%2?o.splice(s-a,a,t):o.splice(s-a,a,t,i)),!0)},ROT.FOV.PreciseShadowcasting=function(t,i){ROT.FOV.call(this,t,i)},ROT.FOV.PreciseShadowcasting.extend(ROT.FOV),ROT.FOV.PreciseShadowcasting.prototype.compute=function(t,i,e,o){if(o(t,i,0,1),this._lightPasses(t,i))for(var r,n,s,a,h,l,c=[],p=1;e>=p;p++)for(var _=this._getCircle(t,i,p),u=_.length,f=0;u>f;f++)if(r=_[f][0],n=_[f][1],a=[f?2*f-1:2*u-1,2*u],h=[2*f+1,2*u],s=!this._lightPasses(r,n),l=this._checkVisibility(a,h,s,c),l&&o(r,n,p,l),2==c.length&&0==c[0][0]&&c[1][0]==c[1][1])return},ROT.FOV.PreciseShadowcasting.prototype._checkVisibility=function(t,i,e,o){if(t[0]>i[0]){var r=this._checkVisibility(t,[t[1],t[1]],e,o),n=this._checkVisibility([0,1],i,e,o);return(r+n)/2}for(var s=0,a=!1;s<o.length;){var h=o[s],l=h[0]*t[1]-t[0]*h[1];if(l>=0){0!=l||s%2||(a=!0);break}s++}for(var c=o.length,p=!1;c--;){var h=o[c],l=i[0]*h[1]-h[0]*i[1];if(l>=0){0==l&&c%2&&(p=!0);break}}var _=!0;if(s==c&&(a||p)?_=!1:a&&p&&s+1==c&&c%2?_=!1:s>c&&s%2&&(_=!1),!_)return 0;var u,f,d=c-s+1;if(d%2)if(s%2){var f=o[s];u=(i[0]*f[1]-f[0]*i[1])/(f[1]*i[1]),e&&o.splice(s,d,i)}else{var f=o[c];u=(f[0]*t[1]-t[0]*f[1])/(t[1]*f[1]),e&&o.splice(s,d,t)}else{if(!(s%2))return e&&o.splice(s,d,t,i),1;var g=o[s],R=o[c];u=(R[0]*g[1]-g[0]*R[1])/(g[1]*R[1]),e&&o.splice(s,d)}var T=(i[0]*t[1]-t[0]*i[1])/(t[1]*i[1]);return u/T},ROT.FOV.RecursiveShadowcasting=function(t,i){ROT.FOV.call(this,t,i)},ROT.FOV.RecursiveShadowcasting.extend(ROT.FOV),ROT.FOV.RecursiveShadowcasting.OCTANTS=[[-1,0,0,1],[0,-1,1,0],[0,-1,-1,0],[-1,0,0,-1],[1,0,0,-1],[0,1,-1,0],[0,1,1,0],[1,0,0,1]],ROT.FOV.RecursiveShadowcasting.prototype.compute=function(t,i,e,o){o(t,i,0,1);for(var r=0;r<ROT.FOV.RecursiveShadowcasting.OCTANTS.length;r++)this._renderOctant(t,i,ROT.FOV.RecursiveShadowcasting.OCTANTS[r],e,o)},ROT.FOV.RecursiveShadowcasting.prototype.compute180=function(t,i,e,o,r){r(t,i,0,1);var n=(o-1+8)%8,s=(o-2+8)%8,a=(o+1+8)%8;this._renderOctant(t,i,ROT.FOV.RecursiveShadowcasting.OCTANTS[s],e,r),this._renderOctant(t,i,ROT.FOV.RecursiveShadowcasting.OCTANTS[n],e,r),this._renderOctant(t,i,ROT.FOV.RecursiveShadowcasting.OCTANTS[o],e,r),this._renderOctant(t,i,ROT.FOV.RecursiveShadowcasting.OCTANTS[a],e,r)},ROT.FOV.RecursiveShadowcasting.prototype.compute90=function(t,i,e,o,r){r(t,i,0,1);var n=(o-1+8)%8;this._renderOctant(t,i,ROT.FOV.RecursiveShadowcasting.OCTANTS[o],e,r),this._renderOctant(t,i,ROT.FOV.RecursiveShadowcasting.OCTANTS[n],e,r)},ROT.FOV.RecursiveShadowcasting.prototype._renderOctant=function(t,i,e,o,r){this._castVisibility(t,i,1,1,0,o+1,e[0],e[1],e[2],e[3],r)},ROT.FOV.RecursiveShadowcasting.prototype._castVisibility=function(t,i,e,o,r,n,s,a,h,l,c){if(!(r>o))for(var p=e;n>=p;p++){for(var _=-p-1,u=-p,f=!1,d=0;0>=_;){_+=1;var g=t+_*s+u*a,R=i+_*h+u*l,T=(_-.5)/(u+.5),v=(_+.5)/(u-.5);if(!(v>o)){if(r>T)break;if(n*n>_*_+u*u&&c(g,R,p,1),f){if(!this._lightPasses(g,R)){d=v;continue}f=!1,o=d}else!this._lightPasses(g,R)&&n>p&&(f=!0,this._castVisibility(t,i,p+1,o,T,n,s,a,h,l,c),d=v)}}if(f)break}},ROT.Color={fromString:function(t){var i,e;if(t in this._cache)i=this._cache[t];else{if("#"==t.charAt(0)){var o=t.match(/[0-9a-f]/gi).map(function(t){return parseInt(t,16)});if(3==o.length)i=o.map(function(t){return 17*t});else{for(var r=0;3>r;r++)o[r+1]+=16*o[r],o.splice(r,1);i=o}}else i=(e=t.match(/rgb\(([0-9, ]+)\)/i))?e[1].split(/\s*,\s*/).map(function(t){return parseInt(t)}):[0,0,0];this._cache[t]=i}return i.slice()},add:function(t){for(var i=t.slice(),e=0;3>e;e++)for(var o=1;o<arguments.length;o++)i[e]+=arguments[o][e];return i},add_:function(t){for(var i=0;3>i;i++)for(var e=1;e<arguments.length;e++)t[i]+=arguments[e][i];return t},multiply:function(t){for(var i=t.slice(),e=0;3>e;e++){for(var o=1;o<arguments.length;o++)i[e]*=arguments[o][e]/255;i[e]=Math.round(i[e])}return i},multiply_:function(t){for(var i=0;3>i;i++){for(var e=1;e<arguments.length;e++)t[i]*=arguments[e][i]/255;t[i]=Math.round(t[i])}return t},interpolate:function(t,i,e){arguments.length<3&&(e=.5);for(var o=t.slice(),r=0;3>r;r++)o[r]=Math.round(o[r]+e*(i[r]-t[r]));return o},interpolateHSL:function(t,i,e){arguments.length<3&&(e=.5);for(var o=this.rgb2hsl(t),r=this.rgb2hsl(i),n=0;3>n;n++)o[n]+=e*(r[n]-o[n]);return this.hsl2rgb(o)},randomize:function(t,i){i instanceof Array||(i=Math.round(ROT.RNG.getNormal(0,i)));for(var e=t.slice(),o=0;3>o;o++)e[o]+=i instanceof Array?Math.round(ROT.RNG.getNormal(0,i[o])):i;return e},rgb2hsl:function(t){var i,e,o=t[0]/255,r=t[1]/255,n=t[2]/255,s=Math.max(o,r,n),a=Math.min(o,r,n),h=(s+a)/2;if(s==a)i=e=0;else{var l=s-a;switch(e=h>.5?l/(2-s-a):l/(s+a),s){case o:i=(r-n)/l+(n>r?6:0);break;case r:i=(n-o)/l+2;break;case n:i=(o-r)/l+4}i/=6}return[i,e,h]},hsl2rgb:function(t){var i=t[2];if(0==t[1])return i=Math.round(255*i),[i,i,i];var e=function(t,i,e){return 0>e&&(e+=1),e>1&&(e-=1),1/6>e?t+6*(i-t)*e:.5>e?i:2/3>e?t+(i-t)*(2/3-e)*6:t},o=t[1],r=.5>i?i*(1+o):i+o-i*o,n=2*i-r,s=e(n,r,t[0]+1/3),a=e(n,r,t[0]),h=e(n,r,t[0]-1/3);return[Math.round(255*s),Math.round(255*a),Math.round(255*h)]},toRGB:function(t){return"rgb("+this._clamp(t[0])+","+this._clamp(t[1])+","+this._clamp(t[2])+")"},toHex:function(t){for(var i=[],e=0;3>e;e++)i.push(this._clamp(t[e]).toString(16).lpad("0",2));return"#"+i.join("")},_clamp:function(t){return 0>t?0:t>255?255:t},_cache:{black:[0,0,0],navy:[0,0,128],darkblue:[0,0,139],mediumblue:[0,0,205],blue:[0,0,255],darkgreen:[0,100,0],green:[0,128,0],teal:[0,128,128],darkcyan:[0,139,139],deepskyblue:[0,191,255],darkturquoise:[0,206,209],mediumspringgreen:[0,250,154],lime:[0,255,0],springgreen:[0,255,127],aqua:[0,255,255],cyan:[0,255,255],midnightblue:[25,25,112],dodgerblue:[30,144,255],forestgreen:[34,139,34],seagreen:[46,139,87],darkslategray:[47,79,79],darkslategrey:[47,79,79],limegreen:[50,205,50],mediumseagreen:[60,179,113],turquoise:[64,224,208],royalblue:[65,105,225],steelblue:[70,130,180],darkslateblue:[72,61,139],mediumturquoise:[72,209,204],indigo:[75,0,130],darkolivegreen:[85,107,47],cadetblue:[95,158,160],cornflowerblue:[100,149,237],mediumaquamarine:[102,205,170],dimgray:[105,105,105],dimgrey:[105,105,105],slateblue:[106,90,205],olivedrab:[107,142,35],slategray:[112,128,144],slategrey:[112,128,144],lightslategray:[119,136,153],lightslategrey:[119,136,153],mediumslateblue:[123,104,238],lawngreen:[124,252,0],chartreuse:[127,255,0],aquamarine:[127,255,212],maroon:[128,0,0],purple:[128,0,128],olive:[128,128,0],gray:[128,128,128],grey:[128,128,128],skyblue:[135,206,235],lightskyblue:[135,206,250],blueviolet:[138,43,226],darkred:[139,0,0],darkmagenta:[139,0,139],saddlebrown:[139,69,19],darkseagreen:[143,188,143],lightgreen:[144,238,144],mediumpurple:[147,112,216],darkviolet:[148,0,211],palegreen:[152,251,152],darkorchid:[153,50,204],yellowgreen:[154,205,50],sienna:[160,82,45],brown:[165,42,42],darkgray:[169,169,169],darkgrey:[169,169,169],lightblue:[173,216,230],greenyellow:[173,255,47],paleturquoise:[175,238,238],lightsteelblue:[176,196,222],powderblue:[176,224,230],firebrick:[178,34,34],darkgoldenrod:[184,134,11],mediumorchid:[186,85,211],rosybrown:[188,143,143],darkkhaki:[189,183,107],silver:[192,192,192],mediumvioletred:[199,21,133],indianred:[205,92,92],peru:[205,133,63],chocolate:[210,105,30],tan:[210,180,140],lightgray:[211,211,211],lightgrey:[211,211,211],palevioletred:[216,112,147],thistle:[216,191,216],orchid:[218,112,214],goldenrod:[218,165,32],crimson:[220,20,60],gainsboro:[220,220,220],plum:[221,160,221],burlywood:[222,184,135],lightcyan:[224,255,255],lavender:[230,230,250],darksalmon:[233,150,122],violet:[238,130,238],palegoldenrod:[238,232,170],lightcoral:[240,128,128],khaki:[240,230,140],aliceblue:[240,248,255],honeydew:[240,255,240],azure:[240,255,255],sandybrown:[244,164,96],wheat:[245,222,179],beige:[245,245,220],whitesmoke:[245,245,245],mintcream:[245,255,250],ghostwhite:[248,248,255],salmon:[250,128,114],antiquewhite:[250,235,215],linen:[250,240,230],lightgoldenrodyellow:[250,250,210],oldlace:[253,245,230],red:[255,0,0],fuchsia:[255,0,255],magenta:[255,0,255],deeppink:[255,20,147],orangered:[255,69,0],tomato:[255,99,71],hotpink:[255,105,180],coral:[255,127,80],darkorange:[255,140,0],lightsalmon:[255,160,122],orange:[255,165,0],lightpink:[255,182,193],pink:[255,192,203],gold:[255,215,0],peachpuff:[255,218,185],navajowhite:[255,222,173],moccasin:[255,228,181],bisque:[255,228,196],mistyrose:[255,228,225],blanchedalmond:[255,235,205],papayawhip:[255,239,213],lavenderblush:[255,240,245],seashell:[255,245,238],cornsilk:[255,248,220],lemonchiffon:[255,250,205],floralwhite:[255,250,240],snow:[255,250,250],yellow:[255,255,0],lightyellow:[255,255,224],ivory:[255,255,240],white:[255,255,255]}},ROT.Lighting=function(t,i){this._reflectivityCallback=t,this._options={passes:1,emissionThreshold:100,range:10},this._fov=null,this._lights={},this._reflectivityCache={},this._fovCache={},this.setOptions(i)},ROT.Lighting.prototype.setOptions=function(t){for(var i in t)this._options[i]=t[i];return t&&t.range&&this.reset(),this},ROT.Lighting.prototype.setFOV=function(t){return this._fov=t,this._fovCache={},this},ROT.Lighting.prototype.setLight=function(t,i,e){var o=t+","+i;return e?this._lights[o]="string"==typeof e?ROT.Color.fromString(e):e:delete this._lights[o],this},ROT.Lighting.prototype.clearLights=function(){this._lights={}},ROT.Lighting.prototype.reset=function(){return this._reflectivityCache={},this._fovCache={},this},ROT.Lighting.prototype.compute=function(t){var i={},e={},o={};for(var r in this._lights){var n=this._lights[r];e[r]=[0,0,0],ROT.Color.add_(e[r],n)}for(var s=0;s<this._options.passes;s++)this._emitLight(e,o,i),s+1!=this._options.passes&&(e=this._computeEmitters(o,i));for(var a in o){var h=a.split(","),l=parseInt(h[0]),c=parseInt(h[1]);t(l,c,o[a])}return this},ROT.Lighting.prototype._emitLight=function(t,i,e){for(var o in t){var r=o.split(","),n=parseInt(r[0]),s=parseInt(r[1]);this._emitLightFromCell(n,s,t[o],i),e[o]=1}return this},ROT.Lighting.prototype._computeEmitters=function(t,i){var e={};for(var o in t)if(!(o in i)){var r=t[o];if(o in this._reflectivityCache)var n=this._reflectivityCache[o];else{var s=o.split(","),a=parseInt(s[0]),h=parseInt(s[1]),n=this._reflectivityCallback(a,h);this._reflectivityCache[o]=n}if(0!=n){for(var l=[],c=0,p=0;3>p;p++){var _=Math.round(r[p]*n);l[p]=_,c+=_}c>this._options.emissionThreshold&&(e[o]=l)}}return e},ROT.Lighting.prototype._emitLightFromCell=function(t,i,e,o){var r=t+","+i;if(r in this._fovCache)var n=this._fovCache[r];else var n=this._updateFOV(t,i);for(var s in n){var a=n[s];if(s in o)var h=o[s];else{var h=[0,0,0];o[s]=h}for(var l=0;3>l;l++)h[l]+=Math.round(e[l]*a)}return this},ROT.Lighting.prototype._updateFOV=function(t,i){var e=t+","+i,o={};this._fovCache[e]=o;var r=this._options.range,n=function(t,i,e,n){var s=t+","+i,a=n*(1-e/r);0!=a&&(o[s]=a)};return this._fov.compute(t,i,r,n.bind(this)),o},ROT.Path=function(t,i,e,o){this._toX=t,this._toY=i,this._fromX=null,this._fromY=null,this._passableCallback=e,this._options={topology:8};for(var r in o)this._options[r]=o[r];this._dirs=ROT.DIRS[this._options.topology],8==this._options.topology&&(this._dirs=[this._dirs[0],this._dirs[2],this._dirs[4],this._dirs[6],this._dirs[1],this._dirs[3],this._dirs[5],this._dirs[7]])},ROT.Path.prototype.compute=function(){},ROT.Path.prototype._getNeighbors=function(t,i){for(var e=[],o=0;o<this._dirs.length;o++){var r=this._dirs[o],n=t+r[0],s=i+r[1];this._passableCallback(n,s)&&e.push([n,s])}return e},ROT.Path.Dijkstra=function(t,i,e,o){ROT.Path.call(this,t,i,e,o),this._computed={},this._todo=[],this._add(t,i,null)},ROT.Path.Dijkstra.extend(ROT.Path),ROT.Path.Dijkstra.prototype.compute=function(t,i,e){var o=t+","+i;if(o in this._computed||this._compute(t,i),o in this._computed)for(var r=this._computed[o];r;)e(r.x,r.y),r=r.prev},ROT.Path.Dijkstra.prototype._compute=function(t,i){for(;this._todo.length;){var e=this._todo.shift();if(e.x==t&&e.y==i)return;for(var o=this._getNeighbors(e.x,e.y),r=0;r<o.length;r++){var n=o[r],s=n[0],a=n[1],h=s+","+a;h in this._computed||this._add(s,a,e)}}},ROT.Path.Dijkstra.prototype._add=function(t,i,e){var o={x:t,y:i,prev:e};this._computed[t+","+i]=o,this._todo.push(o)},ROT.Path.AStar=function(t,i,e,o){ROT.Path.call(this,t,i,e,o),this._todo=[],this._done={},this._fromX=null,this._fromY=null},ROT.Path.AStar.extend(ROT.Path),ROT.Path.AStar.prototype.compute=function(t,i,e){for(this._todo=[],this._done={},this._fromX=t,this._fromY=i,this._add(this._toX,this._toY,null);this._todo.length;){var o=this._todo.shift();if(o.x==t&&o.y==i)break;for(var r=this._getNeighbors(o.x,o.y),n=0;n<r.length;n++){var s=r[n],a=s[0],h=s[1],l=a+","+h;l in this._done||this._add(a,h,o)}}var o=this._done[t+","+i];if(o)for(;o;)e(o.x,o.y),o=o.prev},ROT.Path.AStar.prototype._add=function(t,i,e){var o={x:t,y:i,prev:e,g:e?e.g+1:0,h:this._distance(t,i)};this._done[t+","+i]=o;for(var r=o.g+o.h,n=0;n<this._todo.length;n++){var s=this._todo[n];
if(r<s.g+s.h)return void this._todo.splice(n,0,o)}this._todo.push(o)},ROT.Path.AStar.prototype._distance=function(t,i){switch(this._options.topology){case 4:return Math.abs(t-this._fromX)+Math.abs(i-this._fromY);case 6:var e=Math.abs(t-this._fromX),o=Math.abs(i-this._fromY);return o+Math.max(0,(e-o)/2);case 8:return Math.max(Math.abs(t-this._fromX),Math.abs(i-this._fromY))}throw new Error("Illegal topology")},"function"==typeof define&&"object"==typeof define.amd&&define.amd&&define(function(){return ROT});